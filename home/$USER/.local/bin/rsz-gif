#!/bin/bash

usage() {
  echo "Usage: $0 [OPTION] [FILE]"
  echo "  -h help     Print this help message"
  echo "  -d dir      Output directory"
  echo "  -w width    Set image width"
  echo "  -m minimum  This width is minimum? (default: true)"
  echo
  exit 1
}

WIDTH="700"
DIR="."
MINIMUM=true

NOPTS=0
while getopts "hw:d:m" opt; do
  case $opt in
    h)
      usage
      ;;
    w)
      WIDTH=${OPTARG}
      NOPTS=$((NOPTS+2))
      ;;
    d)
      DIR=${OPTARG}
      NOPTS=$((NOPTS+2))
      ;;
    m)
      MINIMUM=false
      NOPTS=$((NOPTS+1))
      ;;
    ?)
      usage
      ;;
  esac
done
shift $NOPTS

IMG=$1
NEW_NAME=${2:-""}

if [ "$MINIMUM" = true ] ; then
    INPUT_WIDTH=$( identify -format '%w\n' $IMG | head -1 )
    echo WIDTH=$WIDTH
    echo INPUT_WIDTH=$INPUT_WIDTH
    if (( INPUT_WIDTH > WIDTH  )); then
      WIDTH=$INPUT_WIDTH
    fi
fi

if [ -z "$NEW_NAME" ]; then
  echo WIDTH=$WIDTH
  EXT="${IMG##*.}"
  echo EXT=$EXT
  MD5=($(md5sum $IMG))
  echo MD5=$MD5
  NEW_NAME="_"$WIDTH"_"$MD5"."$EXT
  echo NEW_NAME=$NEW_NAME
fi

NEW_IMG=$DIR"/"$NEW_NAME
convert -resize $WIDTH $IMG $NEW_IMG
gifsicle -O3 --colors 16 --lossy=200 -o $NEW_NAME $NEW_IMG
echo $NEW_IMG
